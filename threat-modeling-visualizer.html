<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Threat Modeling Pipeline with Review System</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: linear-gradient(180deg, #1a1f2e 0%, #151a28 100%);
            border-right: 1px solid #2d3548;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding: 30px;
            background: linear-gradient(135deg, #1e2433 0%, #2d1b4e 100%);
            border-bottom: 1px solid #2d3548;
        }

        .sidebar-header h1 {
            font-size: 1.8em;
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #0f1420;
        }

        .topbar {
            height: 70px;
            background: #1a1f2e;
            border-bottom: 1px solid #2d3548;
            display: flex;
            align-items: center;
            padding: 0 30px;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* Pipeline Steps */
        .pipeline-step {
            padding: 20px 25px;
            margin: 5px 10px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 0 8px 8px 0;
        }

        .pipeline-step:hover {
            background: rgba(139, 92, 246, 0.08);
            border-left-color: #8b5cf6;
            transform: translateX(5px);
        }

        .pipeline-step.active {
            background: rgba(139, 92, 246, 0.15);
            border-left-color: #8b5cf6;
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.2);
        }

        .pipeline-step.completed {
            border-left-color: #10b981;
        }

        .pipeline-step.completed::after {
            content: '‚úì';
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #10b981;
            font-weight: bold;
            font-size: 1.2em;
        }

        .pipeline-step.error {
            border-left-color: #ef4444;
        }

        .pipeline-step.running {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .pipeline-step.has-review {
            position: relative;
        }

        .pipeline-step.has-review::before {
            content: '';
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: #f59e0b;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(245, 158, 11, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.8; transform: translateY(-50%) scale(1.1); }
            100% { opacity: 1; transform: translateY(-50%) scale(1); }
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.05em;
        }

        /* Forms */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #d1d5db;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: #1a1f2e;
            border: 2px solid #2d3548;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
            background: #1e2433;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: #2d3548;
            color: #e0e0e0;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        /* Cards */
        .card {
            background: #1a1f2e;
            border: 1px solid #2d3548;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2d3548;
        }

        /* Console */
        .console {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .console-line {
            margin-bottom: 8px;
            padding: 2px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .console-timestamp {
            color: #6b7280;
            white-space: nowrap;
            font-size: 0.85em;
        }

        .console-message {
            flex: 1;
            word-break: break-word;
        }

        .console-error {
            color: #ff4444;
        }

        .console-warning {
            color: #ffaa00;
        }

        .console-success {
            color: #00ff00;
        }

        .console-info {
            color: #00aaff;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #374151;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            background: #0a0e1a;
            padding: 5px;
            border-radius: 10px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: #e0e0e0;
            background: rgba(139, 92, 246, 0.1);
        }

        .tab.active {
            color: white;
            background: #8b5cf6;
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .tag-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .tag-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .tag-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* JSON Viewer */
        .json-viewer {
            background: #0a0e1a;
            border: 2px solid #2d3548;
            border-radius: 12px;
            padding: 20px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
        }

        /* Review Interface Styles */
        .review-interface {
            max-width: 800px;
            margin: 0 auto;
        }

        .review-item-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 2px solid #8b5cf6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .confidence-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confidence-bar {
            width: 100px;
            height: 8px;
            background: #2d3548;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .confidence-high { background: #10b981; }
        .confidence-medium { background: #f59e0b; }
        .confidence-low { background: #ef4444; }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
        }

        .status-indicator.disconnected {
            background: #ef4444;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
        }

        /* JSON Syntax Highlighting */
        .json-key {
            color: #ff79c6;
        }

        .json-string {
            color: #f1fa8c;
        }

        .json-number {
            color: #bd93f9;
        }

        .json-boolean {
            color: #50fa7b;
        }

        .json-null {
            color: #6272a4;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 1001;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .notification.info {
            background: #3b82f6;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #1a1f2e;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%);
            transition: width 0.3s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0e1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #2d3548;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #374151;
        }

        /* Checkbox */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #8b5cf6;
        }

        /* Batch Review Styles */
        .batch-review-item {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #2d3548;
            transition: background 0.2s ease;
        }

        .batch-review-item:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .batch-review-item.selected {
            background: rgba(139, 92, 246, 0.1);
        }

        /* Review Dashboard Stats */
        .review-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .review-stat-card {
            background: #0a0e1a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #2d3548;
        }

        .review-stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .review-stat-label {
            font-size: 0.9em;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // API endpoints
        const API_BASE = 'http://localhost:5000/api';
        
        // Initialize Socket.IO
        const socket = io('http://localhost:5000');

        // JSON Syntax Highlighter
        const highlightJSON = (json) => {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, null, 2);
            }
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return `<span class="${cls}">${match}</span>`;
            });
        };

        // Notification Component
        const Notification = ({ type, message, onClose }) => {
            React.useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className={`notification ${type}`}>
                    {message}
                </div>
            );
        };

        // Confidence Indicator Component
        const ConfidenceIndicator = ({ confidence }) => (
            <div className="confidence-indicator">
                <div className="confidence-bar">
                    <div 
                        className={`confidence-fill ${
                            confidence > 0.8 ? 'confidence-high' : 
                            confidence > 0.5 ? 'confidence-medium' : 'confidence-low'
                        }`}
                        style={{width: `${confidence * 100}%`}}
                    />
                </div>
                <span style={{fontSize: '0.9em', color: '#9ca3af'}}>
                    {(confidence * 100).toFixed(0)}%
                </span>
            </div>
        );

        // Review Interface Component
        const ReviewInterface = ({ stepReview, onComplete }) => {
            const [currentItemIndex, setCurrentItemIndex] = React.useState(0);
            const [reviewData, setReviewData] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [reviewItems, setReviewItems] = React.useState([]);
            const [reviewer, setReviewer] = React.useState(
                localStorage.getItem('reviewer_name') || ''
            );

            React.useEffect(() => {
                loadReviewItems();
            }, [stepReview.stepIndex]);

            const loadReviewItems = async () => {
                try {
                    const response = await fetch(`${API_BASE}/review-queue/${stepReview.stepIndex}`);
                    const data = await response.json();
                    setReviewItems(data.items || []);
                    setLoading(false);
                } catch (error) {
                    console.error('Failed to load review items:', error);
                    setLoading(false);
                }
            };

            const currentItem = reviewItems[currentItemIndex];

            const submitReview = async (decision) => {
                if (!reviewer) {
                    alert('Please enter your name to submit reviews');
                    return;
                }

                localStorage.setItem('reviewer_name', reviewer);

                const corrections = reviewData[currentItem.id] || {};
                
                try {
                    const response = await fetch(`${API_BASE}/review-item/${currentItem.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reviewer,
                            decision,
                            corrections,
                            comments: corrections.comments
                        })
                    });

                    if (response.ok) {
                        // Move to next item or complete
                        if (currentItemIndex < reviewItems.length - 1) {
                            setCurrentItemIndex(currentItemIndex + 1);
                        } else {
                            onComplete();
                        }
                    }
                } catch (error) {
                    console.error('Review submission failed:', error);
                }
            };

            if (loading) {
                return <div className="loading-spinner"></div>;
            }

            if (reviewItems.length === 0) {
                return (
                    <div className="card" style={{textAlign: 'center', padding: '60px'}}>
                        <div style={{fontSize: '3em', marginBottom: '20px'}}>‚úÖ</div>
                        <h3>No items need review</h3>
                        <p style={{color: '#9ca3af', marginTop: '10px'}}>
                            All items have high confidence scores
                        </p>
                        <button 
                            className="btn btn-primary" 
                            onClick={onComplete}
                            style={{marginTop: '20px'}}
                        >
                            Continue to Next Step
                        </button>
                    </div>
                );
            }

            return (
                <div className="review-interface">
                    {/* Progress Bar */}
                    <div style={{marginBottom: '30px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                            <span>Review Progress</span>
                            <span>{currentItemIndex + 1} of {reviewItems.length}</span>
                        </div>
                        <div className="progress-bar">
                            <div 
                                className="progress-bar-fill" 
                                style={{width: `${((currentItemIndex + 1) / reviewItems.length) * 100}%`}}
                            />
                        </div>
                    </div>

                    {/* Reviewer Input */}
                    <div className="form-group" style={{marginBottom: '30px'}}>
                        <label className="form-label">Reviewer Name</label>
                        <input
                            type="text"
                            className="form-control"
                            value={reviewer}
                            onChange={(e) => setReviewer(e.target.value)}
                            placeholder="Enter your name"
                        />
                    </div>

                    {/* Current Review Item */}
                    {currentItem && (
                        <div className="review-item-card">
                            <div className="card-header">
                                <h3>Review: {currentItem.type.replace(/_/g, ' ').toUpperCase()}</h3>
                                <ConfidenceIndicator confidence={currentItem.confidence} />
                            </div>

                            {/* Display current value */}
                            <div style={{marginBottom: '25px'}}>
                                <h4 style={{marginBottom: '15px'}}>Current Extraction:</h4>
                                <div className="json-viewer" style={{maxHeight: '200px'}}>
                                    <pre>{JSON.stringify(currentItem.value, null, 2)}</pre>
                                </div>
                            </div>

                            {/* Questions */}
                            {currentItem.questions && (
                                <div style={{marginBottom: '25px'}}>
                                    <h4 style={{marginBottom: '15px'}}>Please Verify:</h4>
                                    {currentItem.questions.map((question, idx) => (
                                        <div key={idx} style={{
                                            padding: '15px',
                                            background: 'rgba(0,0,0,0.2)',
                                            borderRadius: '8px',
                                            marginBottom: '10px'
                                        }}>
                                            ‚ùì {question}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Attribute Fields */}
                            {currentItem.attributes_needed && (
                                <div style={{marginBottom: '25px'}}>
                                    <h4 style={{marginBottom: '15px'}}>Required Information:</h4>
                                    {Object.entries(currentItem.attributes_needed).map(([attr, config]) => (
                                        <div key={attr} className="form-group">
                                            <label className="form-label">{config.question}</label>
                                            {config.hint && (
                                                <div style={{
                                                    fontSize: '0.9em',
                                                    color: '#8b5cf6',
                                                    marginBottom: '10px'
                                                }}>
                                                    üí° Suggestion: {config.hint}
                                                </div>
                                            )}
                                            {config.options ? (
                                                <select
                                                    className="form-control"
                                                    value={reviewData[currentItem.id]?.[attr] || ''}
                                                    onChange={(e) => setReviewData({
                                                        ...reviewData,
                                                        [currentItem.id]: {
                                                            ...reviewData[currentItem.id],
                                                            [attr]: e.target.value
                                                        }
                                                    })}
                                                >
                                                    <option value="">Select {attr}...</option>
                                                    {config.options.map(opt => (
                                                        <option key={opt} value={opt}>{opt}</option>
                                                    ))}
                                                </select>
                                            ) : (
                                                <input
                                                    type="text"
                                                    className="form-control"
                                                    value={reviewData[currentItem.id]?.[attr] || ''}
                                                    onChange={(e) => setReviewData({
                                                        ...reviewData,
                                                        [currentItem.id]: {
                                                            ...reviewData[currentItem.id],
                                                            [attr]: e.target.value
                                                        }
                                                    })}
                                                />
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Comments */}
                            <div className="form-group" style={{marginBottom: '25px'}}>
                                <label className="form-label">Additional Comments (Optional)</label>
                                <textarea
                                    className="form-control"
                                    rows={3}
                                    value={reviewData[currentItem.id]?.comments || ''}
                                    onChange={(e) => setReviewData({
                                        ...reviewData,
                                        [currentItem.id]: {
                                            ...reviewData[currentItem.id],
                                            comments: e.target.value
                                        }
                                    })}
                                    placeholder="Any additional context or corrections..."
                                />
                            </div>

                            {/* Action Buttons */}
                            <div style={{display: 'flex', gap: '15px', justifyContent: 'flex-end'}}>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => submitReview('skip')}
                                >
                                    Skip for Now
                                </button>
                                <button 
                                    className="btn btn-danger"
                                    onClick={() => submitReview('reject')}
                                >
                                    Incorrect - Needs Rework
                                </button>
                                <button 
                                    className="btn btn-success"
                                    onClick={() => submitReview('approve')}
                                    disabled={
                                        currentItem.attributes_needed && 
                                        !Object.keys(currentItem.attributes_needed).every(
                                            attr => reviewData[currentItem.id]?.[attr]
                                        )
                                    }
                                >
                                    Approve {currentItem.attributes_needed ? 'with Updates' : ''}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Review Dashboard Component
        const ReviewDashboard = () => {
            const [summary, setSummary] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                loadSummary();
                const interval = setInterval(loadSummary, 5000);
                return () => clearInterval(interval);
            }, []);

            const loadSummary = async () => {
                try {
                    const response = await fetch(`${API_BASE}/review-summary`);
                    const data = await response.json();
                    setSummary(data);
                    setLoading(false);
                } catch (error) {
                    console.error('Failed to load summary:', error);
                    setLoading(false);
                }
            };

            const exportReport = async () => {
                try {
                    const response = await fetch(`${API_BASE}/export/review-report`);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'review_report.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    console.error('Export failed:', error);
                }
            };

            if (loading || !summary) return <div className="loading-spinner"></div>;

            return (
                <div>
                    <div className="card">
                        <div className="card-header">
                            <h2>Review Dashboard</h2>
                            <button className="btn btn-secondary" onClick={exportReport}>
                                üì• Export Report
                            </button>
                        </div>

                        {/* Statistics Grid */}
                        <div className="review-stats-grid">
                            <div className="review-stat-card">
                                <div className="review-stat-value" style={{color: '#3b82f6'}}>
                                    {summary.total_items}
                                </div>
                                <div className="review-stat-label">Total Items</div>
                            </div>
                            <div className="review-stat-card">
                                <div className="review-stat-value" style={{color: '#10b981'}}>
                                    {summary.reviewed}
                                </div>
                                <div className="review-stat-label">Reviewed</div>
                            </div>
                            <div className="review-stat-card">
                                <div className="review-stat-value" style={{color: '#f59e0b'}}>
                                    {summary.pending}
                                </div>
                                <div className="review-stat-label">Pending</div>
                            </div>
                            <div className="review-stat-card">
                                <div className="review-stat-value" style={{color: '#8b5cf6'}}>
                                    {summary.quality_metrics?.approval_rate 
                                        ? `${(summary.quality_metrics.approval_rate * 100).toFixed(0)}%`
                                        : 'N/A'}
                                </div>
                                <div className="review-stat-label">Approval Rate</div>
                            </div>
                        </div>

                        {/* Progress by Step */}
                        <div style={{marginBottom: '30px'}}>
                            <h3>Progress by Step</h3>
                            {Object.entries(summary.by_step || {}).map(([step, data]) => (
                                <div key={step} style={{marginBottom: '15px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '5px'}}>
                                        <span>Step {step}</span>
                                        <span>{data.reviewed}/{data.total}</span>
                                    </div>
                                    <div className="progress-bar">
                                        <div 
                                            className="progress-bar-fill" 
                                            style={{
                                                width: `${data.total > 0 ? (data.reviewed / data.total) * 100 : 0}%`,
                                                background: data.reviewed === data.total ? '#10b981' : '#8b5cf6'
                                            }}
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Recent Reviews */}
                        {summary.recent_reviews && summary.recent_reviews.length > 0 && (
                            <div>
                                <h3>Recent Reviews</h3>
                                <div style={{maxHeight: '300px', overflow: 'auto'}}>
                                    {summary.recent_reviews.map((review, idx) => (
                                        <div key={idx} style={{
                                            padding: '15px',
                                            background: 'rgba(0,0,0,0.2)',
                                            borderRadius: '8px',
                                            marginBottom: '10px'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                                <span>
                                                    <strong>{review.reviewer}</strong> reviewed Step {review.step}
                                                </span>
                                                <span style={{color: '#9ca3af', fontSize: '0.9em'}}>
                                                    {new Date(review.timestamp).toLocaleString()}
                                                </span>
                                            </div>
                                            <div style={{marginTop: '5px', fontSize: '0.9em', color: '#9ca3af'}}>
                                                Decision: <span className={`tag tag-${review.decision === 'approve' ? 'success' : 'warning'}`}>
                                                    {review.decision}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main App Component (Enhanced)
        const ThreatModelingApp = () => {
            const [currentStep, setCurrentStep] = React.useState(0);
            const [pipelineState, setPipelineState] = React.useState({
                steps: [
                    { id: 1, name: 'Upload Document', status: 'pending', data: null },
                    { id: 2, name: 'Extract DFD', status: 'pending', data: null },
                    { id: 3, name: 'Generate Threats', status: 'pending', data: null },
                    { id: 4, name: 'Refine Threats', status: 'pending', data: null },
                    { id: 5, name: 'Analyze Attack Paths', status: 'pending', data: null }
                ],
                logs: [],
                stepReview: null,
                reviewsNeeded: {}
            });
            const [loading, setLoading] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('overview');
            const [currentOperation, setCurrentOperation] = React.useState('');
            const [showConsole, setShowConsole] = React.useState(true);
            const [autoRun, setAutoRun] = React.useState(false);
            const [viewMode, setViewMode] = React.useState('visual');
            const [notification, setNotification] = React.useState(null);
            const [reviewMode, setReviewMode] = React.useState('summary');
            const [configuration, setConfiguration] = React.useState({
                timeout: 5000,
                llm_provider: 'scaleway',
                llm_model: 'llama-3.3-70b-instruct',
                local_llm_endpoint: 'http://localhost:11434/api/generate',
                qdrant_collection: 'threat_patterns',
                qdrant_url: 'http://localhost:6333',
                custom_system_prompt: '',
                mitre_enabled: true,
                mitre_version: 'v13.1'
            });
            const [configStatus, setConfigStatus] = React.useState({
                llm: false,
                qdrant: false,
                mitre: true
            });
            
            const logEndRef = React.useRef(null);
            const logPollInterval = React.useRef(null);

            // Socket.IO listeners
            React.useEffect(() => {
                socket.on('connected', (data) => {
                    console.log('Connected to review system:', data);
                });

                socket.on('reviews_available', (data) => {
                    setPipelineState(prev => ({
                        ...prev,
                        reviewsNeeded: {
                            ...prev.reviewsNeeded,
                            [data.step]: data.count
                        }
                    }));
                    showNotification(`${data.count} items need review for Step ${data.step}`, 'info');
                });

                socket.on('review_update', (data) => {
                    // Refresh status
                    loadPipelineStatus();
                });

                socket.on('batch_review_complete', (data) => {
                    showNotification(`${data.count} items ${data.decision}ed by ${data.reviewer}`, 'success');
                    loadPipelineStatus();
                });

                return () => {
                    socket.off('connected');
                    socket.off('reviews_available');
                    socket.off('review_update');
                    socket.off('batch_review_complete');
                };
            }, []);

            // Load configuration on mount
            React.useEffect(() => {
                loadConfiguration();
                checkConnectionStatus();
                loadPipelineStatus();
            }, []);

            // Auto-scroll logs
            React.useEffect(() => {
                if (logEndRef.current) {
                    logEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [pipelineState.logs]);

            // Enhanced log polling
            React.useEffect(() => {
                const pollLogs = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/logs?limit=200`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.logs && data.logs.length > pipelineState.logs.length) {
                                setPipelineState(prev => ({ ...prev, logs: data.logs }));
                            }
                        }
                    } catch (error) {
                        console.error('Failed to fetch logs:', error);
                    }
                };

                if (loading) {
                    logPollInterval.current = setInterval(pollLogs, 1000);
                } else {
                    logPollInterval.current = setInterval(pollLogs, 3000);
                }

                return () => {
                    if (logPollInterval.current) {
                        clearInterval(logPollInterval.current);
                    }
                };
            }, [loading, pipelineState.logs.length]);

            // Load configuration
            const loadConfiguration = async () => {
                try {
                    const response = await fetch(`${API_BASE}/configuration`);
                    if (response.ok) {
                        const data = await response.json();
                        setConfiguration(data);
                    }
                } catch (error) {
                    console.error('Failed to load configuration:', error);
                }
            };

            // Load pipeline status
            const loadPipelineStatus = async () => {
                try {
                    const response = await fetch(`${API_BASE}/status`);
                    if (response.ok) {
                        const data = await response.json();
                        // Update step statuses based on backend state
                        setPipelineState(prev => {
                            const newSteps = [...prev.steps];
                            data.completed_steps.forEach(stepNum => {
                                if (stepNum <= newSteps.length) {
                                    newSteps[stepNum - 1].status = 'completed';
                                    newSteps[stepNum - 1].data = { count: 1 }; // Placeholder
                                }
                            });
                            return { 
                                ...prev, 
                                steps: newSteps,
                                reviewsNeeded: data.pending_reviews || {}
                            };
                        });
                    }
                } catch (error) {
                    console.error('Failed to load pipeline status:', error);
                }
            };

            // Check connection status
            const checkConnectionStatus = async () => {
                try {
                    const response = await fetch(`${API_BASE}/health`);
                    if (response.ok) {
                        const data = await response.json();
                        setConfigStatus({
                            llm: data.has_api_key || configuration.llm_provider === 'local',
                            qdrant: data.scripts_available,
                            mitre: true
                        });
                    }
                } catch (error) {
                    console.error('Failed to check status:', error);
                }
            };

            // Update configuration
            const updateConfiguration = async (updates) => {
                try {
                    const response = await fetch(`${API_BASE}/configuration`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updates)
                    });
                    if (response.ok) {
                        const data = await response.json();
                        setConfiguration(data.configuration);
                        showNotification('Configuration updated successfully', 'success');
                        checkConnectionStatus();
                    }
                } catch (error) {
                    showNotification('Failed to update configuration', 'error');
                }
            };

            // Show notification
            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 5000);
            };

            // File upload handler
            const handleFileUpload = async (files) => {
                const formData = new FormData();
                formData.append('document', files[0]);

                setLoading(true);
                setCurrentOperation('Uploading and extracting text from document...');
                updateStepStatus(0, 'running');
                
                try {
                    addLog('Starting document upload...', 'info');
                    
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    updateStepStatus(0, 'completed', data);
                    addLog(`Document uploaded successfully: ${data.filename}`, 'success');
                    addLog(`Extracted ${data.text_length} characters`, 'info');
                    setLoading(false);
                    setCurrentOperation('');
                    
                    // Show review for the uploaded document
                    setPipelineState(prev => ({
                        ...prev,
                        stepReview: {
                            stepIndex: 0,
                            data: data,
                            nextStep: 1
                        }
                    }));
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    updateStepStatus(0, 'error');
                    addLog(`Upload failed: ${error.message}`, 'error');
                    setLoading(false);
                    setCurrentOperation('');
                    showNotification(`Upload failed: ${error.message}`, 'error');
                }
            };

            // Enhanced step running with progress tracking
            const runStep = async (stepIndex, skipReview = false) => {
                const step = pipelineState.steps[stepIndex];
                setLoading(true);
                updateStepStatus(stepIndex, 'running');
                
                const stepDescriptions = {
                    1: 'Extracting DFD components from document...',
                    2: 'Generating threats using STRIDE methodology...',
                    3: 'Refining threats and removing duplicates...',
                    4: 'Analyzing attack paths and scenarios...'
                };
                
                setCurrentOperation(stepDescriptions[stepIndex] || `Running ${step.name}...`);
                addLog(`Starting: ${step.name}`, 'info');

                // Start progress polling for longer-running steps
                let progressInterval = null;
                if (stepIndex >= 2) {
                    progressInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`${API_BASE}/step-progress/${step.id}`);
                            if (response.ok) {
                                const progressData = await response.json();
                                if (progressData.progress !== undefined) {
                                    setCurrentOperation(
                                        `${stepDescriptions[stepIndex]} (${progressData.progress}%) - ${progressData.details || progressData.message}`
                                    );
                                }
                            }
                        } catch (error) {
                            // Ignore progress errors
                        }
                    }, 2000);
                }

                try {
                    const startTime = Date.now();
                    
                    const response = await fetch(`${API_BASE}/run-step`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            step: step.id,
                            input: stepIndex > 0 ? pipelineState.steps[stepIndex - 1]?.data : {}
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Step failed');
                    }
                    
                    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                    addLog(`${step.name} completed in ${duration}s - found ${data.count || 0} items`, 'success');
                    
                    if (data.review_needed && data.review_needed > 0) {
                        setPipelineState(prev => ({
                            ...prev,
                            reviewsNeeded: {
                                ...prev.reviewsNeeded,
                                [stepIndex]: data.review_needed
                            }
                        }));
                    }
                    
                    setLoading(false);
                    setCurrentOperation('');
                    
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                    
                    if (skipReview || autoRun) {
                        updateStepStatus(stepIndex, 'completed', data);
                        
                        if (autoRun && stepIndex < pipelineState.steps.length - 1) {
                            setTimeout(() => runStep(stepIndex + 1, true), 1000);
                        }
                    } else {
                        setPipelineState(prev => ({
                            ...prev,
                            stepReview: {
                                stepIndex: stepIndex,
                                data: data,
                                nextStep: stepIndex < pipelineState.steps.length - 1 ? stepIndex + 1 : null
                            }
                        }));
                    }
                    
                } catch (error) {
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                    
                    updateStepStatus(stepIndex, 'error');
                    addLog(`${step.name} failed: ${error.message}`, 'error');
                    setLoading(false);
                    setCurrentOperation('');
                    setAutoRun(false);
                    showNotification(`Step failed: ${error.message}`, 'error');
                }
            };

            // Accept reviewed data and continue
            const acceptReviewedData = (data, continueToNext = true) => {
                const { stepIndex, nextStep } = pipelineState.stepReview;
                
                updateStepStatus(stepIndex, 'completed', data);
                setPipelineState(prev => ({ ...prev, stepReview: null }));
                
                if (nextStep !== null && nextStep !== undefined) {
                    setCurrentStep(nextStep);
                    
                    if (continueToNext) {
                        setTimeout(() => runStep(nextStep, false), 500);
                    }
                }
            };

            // Update step status
            const updateStepStatus = (index, status, data = null) => {
                setPipelineState(prev => {
                    const newSteps = [...prev.steps];
                    newSteps[index] = { ...newSteps[index], status, data };
                    return { ...prev, steps: newSteps };
                });
            };

            // Add log entry
            const addLog = (message, type = 'info') => {
                setPipelineState(prev => ({
                    ...prev,
                    logs: [...prev.logs, { message, type, timestamp: new Date() }]
                }));
            };

            // Run all remaining steps
            const runRemainingSteps = () => {
                const nextIncompleteStep = pipelineState.steps.findIndex(
                    (step) => step.status !== 'completed'
                );
                
                if (nextIncompleteStep !== -1) {
                    setAutoRun(true);
                    runStep(nextIncompleteStep, autoRun);
                } else {
                    addLog('All steps are already completed!', 'info');
                    showNotification('All steps are already completed', 'info');
                }
            };

            // Export all data
            const exportAllData = async () => {
                try {
                    const response = await fetch(`${API_BASE}/export/all`);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'threat_model_complete.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    addLog('Exported complete threat model', 'success');
                    showNotification('Threat model exported successfully', 'success');
                } catch (error) {
                    addLog(`Export failed: ${error.message}`, 'error');
                    showNotification('Export failed', 'error');
                }
            };

            // Debug function to load existing files
            const debugLoadFiles = async () => {
                try {
                    addLog('Loading existing files from disk...', 'info');
                    const response = await fetch(`${API_BASE}/debug-load-files`, {
                        method: 'GET'
                    });
                    const data = await response.json();
                    console.log('Debug load result:', data);
                    
                    if (response.ok) {
                        // Update the pipeline state with the loaded data
                        setPipelineState(prev => {
                            const newSteps = [...prev.steps];
                            
                            // Update each step based on the files_loaded data
                            Object.entries(data.files_loaded || {}).forEach(([stepNum, fileInfo]) => {
                                const stepIndex = parseInt(stepNum) - 1;
                                if (stepIndex >= 0 && stepIndex < newSteps.length && fileInfo.status === 'loaded') {
                                    newSteps[stepIndex] = {
                                        ...newSteps[stepIndex],
                                        status: 'completed',
                                        data: {
                                            count: fileInfo.keys ? fileInfo.keys.length : 1,
                                            loaded_from_disk: true,
                                            file_loaded: fileInfo.file,
                                            description: fileInfo.description
                                        }
                                    };
                                    addLog(`‚úÖ Step ${stepNum} (${fileInfo.description}) loaded from ${fileInfo.file}`, 'success');
                                    
                                    if (fileInfo.review_items > 0) {
                                        prev.reviewsNeeded[parseInt(stepNum)] = fileInfo.review_items;
                                    }
                                } else if (fileInfo.status === 'simulated') {
                                    newSteps[stepIndex] = {
                                        ...newSteps[stepIndex],
                                        status: 'completed',
                                        data: {
                                            count: 1,
                                            simulated: true,
                                            description: fileInfo.description
                                        }
                                    };
                                    addLog(`‚úÖ Step ${stepNum} simulated for recovery`, 'info');
                                } else if (fileInfo.status === 'error') {
                                    addLog(`‚ùå Failed to load step ${stepNum}: ${fileInfo.error}`, 'error');
                                } else if (fileInfo.status === 'not_found') {
                                    addLog(`‚ö†Ô∏è Step ${stepNum} file not found: ${fileInfo.file}`, 'warning');
                                }
                            });
                            
                            return {
                                ...prev,
                                steps: newSteps,
                                current_session: data.current_session
                            };
                        });
                        
                        showNotification('Debug files loaded successfully', 'success');
                        
                        // Set current step to the highest completed step + 1
                        const completedSteps = data.completed_steps || [];
                        const nextStep = Math.min(completedSteps.length, 4);
                        setCurrentStep(nextStep);
                        
                        addLog(`üéØ Set current step to ${nextStep + 1}`, 'info');
                        
                    } else {
                        throw new Error(data.error || 'Debug load failed');
                    }
                } catch (error) {
                    console.error('Debug load failed:', error);
                    addLog(`Debug load failed: ${error.message}`, 'error');
                    showNotification('Debug load failed', 'error');
                }
            };

            // Add this right after the debugLoadFiles function
            const debugShowState = async () => {
                try {
                    const response = await fetch(`${API_BASE}/debug-state`);
                    const data = await response.json();
                    console.log('Current pipeline state:', data);
                    addLog(`Pipeline state: Steps ${data.completed_steps.join(', ')} completed`, 'info');
                } catch (error) {
                    console.error('Failed to get debug state:', error);
                }
            };

            return (
                <div className="app-container">
                    {notification && (
                        <Notification 
                            type={notification.type}
                            message={notification.message}
                            onClose={() => setNotification(null)}
                        />
                    )}

                    {/* Sidebar */}
                    <div className="sidebar">
                        <div className="sidebar-header">
                            <h1>üõ°Ô∏è Threat Modeling</h1>
                            <p style={{fontSize: '0.95em', color: '#9ca3af'}}>
                                Advanced Security Analysis Pipeline
                            </p>
                        </div>
                        
                        {/* Configuration Status */}
                        <div style={{padding: '20px', borderBottom: '1px solid #2d3548'}}>
                            <div className="config-status">
                                <div className="config-status-item" style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <span className={`status-indicator ${configStatus.llm ? 'connected' : 'disconnected'}`}></span>
                                    <span>LLM</span>
                                </div>
                                <div className="config-status-item" style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <span className={`status-indicator ${configStatus.qdrant ? 'connected' : 'disconnected'}`}></span>
                                    <span>Backend</span>
                                </div>
                                <div className="config-status-item" style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <span className={`status-indicator ${configStatus.mitre ? 'connected' : 'disconnected'}`}></span>
                                    <span>MITRE</span>
                                </div>
                            </div>
                        </div>
                        
                        {/* Pipeline Steps */}
                        {pipelineState.steps.map((step, index) => (
                            <PipelineStep
                                key={step.id}
                                step={step}
                                index={index}
                                active={currentStep === index}
                                hasReview={pipelineState.reviewsNeeded[index + 1] > 0}
                                onClick={() => setCurrentStep(index)}
                            />
                        ))}
                        
                        {/* Controls */}
                        <div style={{padding: '25px', marginTop: 'auto', display: 'flex', flexDirection: 'column', gap: '15px'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '12px', padding: '10px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px'}}>
                                <input 
                                    type="checkbox" 
                                    id="autoRun" 
                                    checked={autoRun}
                                    onChange={(e) => setAutoRun(e.target.checked)}
                                    style={{cursor: 'pointer', width: '18px', height: '18px'}}
                                />
                                <label htmlFor="autoRun" style={{cursor: 'pointer', fontSize: '0.95em'}}>
                                    Auto-continue after review
                                </label>
                            </div>
                            
                            <button 
                                className="btn btn-primary" 
                                style={{width: '100%'}}
                                onClick={runRemainingSteps}
                                disabled={loading || pipelineState.steps[0].status !== 'completed'}
                                title="Run all remaining steps"
                            >
                                {loading ? 'Running...' : 'Run All Steps'}
                            </button>
                            
                            <button 
                                className="btn btn-success" 
                                style={{width: '100%'}}
                                onClick={exportAllData}
                                disabled={loading || pipelineState.steps.some(s => s.status !== 'completed')}
                            >
                                Export Complete Model
                            </button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="main-content">
                        <div className="topbar">
                            <div style={{display: 'flex', gap: '5px', background: '#0a0e1a', padding: '5px', borderRadius: '10px'}}>
                                <button 
                                    className={`tab ${activeTab === 'overview' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('overview')}
                                >
                                    üìä Overview
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'config' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('config')}
                                >
                                    ‚öôÔ∏è Configuration
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'edit' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('edit')}
                                >
                                    ‚úèÔ∏è Edit Data
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'review' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('review')}
                                >
                                    üë• Review
                                    {Object.values(pipelineState.reviewsNeeded).reduce((a, b) => a + b, 0) > 0 && (
                                        <span className="tag tag-warning" style={{marginLeft: '8px', padding: '2px 8px', fontSize: '0.8em'}}>
                                            {Object.values(pipelineState.reviewsNeeded).reduce((a, b) => a + b, 0)}
                                        </span>
                                    )}
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'visualize' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('visualize')}
                                >
                                    üìà Visualize
                                </button>
                            </div>
                            
                            <div style={{display: 'flex', gap: '15px', alignItems: 'center'}}>
                                <button 
                                    className="btn btn-secondary btn-sm"
                                    onClick={debugLoadFiles}
                                    title="Load existing output files for debugging"
                                >
                                    üîß Debug Load
                                </button>
                                <button 
                                    className="btn btn-secondary btn-sm"
                                    onClick={debugShowState}
                                    title="Check pipeline state"
                                >
                                    üîç State
                                </button>
                                <button 
                                    className="btn btn-secondary btn-sm"
                                    onClick={() => setShowConsole(!showConsole)}
                                >
                                    {showConsole ? 'üîΩ' : 'üîº'} Console
                                </button>
                            </div>
                        </div>

                        <div className="content-area" style={{paddingBottom: showConsole ? '420px' : '30px'}}>
                            {/* Show review screen if there's data pending review */}
                            {pipelineState.stepReview && (
                                <StepReviewScreen
                                    stepReview={pipelineState.stepReview}
                                    stepName={pipelineState.steps[pipelineState.stepReview.stepIndex].name}
                                    onAccept={acceptReviewedData}
                                    onEdit={() => {
                                        const { stepIndex, data } = pipelineState.stepReview;
                                        updateStepStatus(stepIndex, 'completed', data);
                                        setPipelineState(prev => ({ ...prev, stepReview: null }));
                                        setCurrentStep(stepIndex);
                                        setActiveTab('edit');
                                    }}
                                    reviewMode={reviewMode}
                                    setReviewMode={setReviewMode}
                                    needsExpertReview={pipelineState.reviewsNeeded[pipelineState.stepReview.stepIndex] > 0}
                                />
                            )}
                            
                            {/* Regular content when not reviewing */}
                            {!pipelineState.stepReview && (
                                <>
                                    {activeTab === 'overview' && (
                                        <OverviewTab 
                                            step={pipelineState.steps[currentStep]}
                                            pipelineState={pipelineState}
                                            currentStep={currentStep}
                                            onUpload={handleFileUpload}
                                            onRunStep={() => runStep(currentStep, false)}
                                        />
                                    )}
                                    
                                    {activeTab === 'config' && (
                                        <ConfigurationTab
                                            configuration={configuration}
                                            onUpdate={updateConfiguration}
                                            onRefresh={checkConnectionStatus}
                                        />
                                    )}
                                    
                                    {activeTab === 'edit' && (
                                        <EditTab 
                                            step={pipelineState.steps[currentStep]}
                                            viewMode={viewMode}
                                        />
                                    )}
                                    
                                    {activeTab === 'review' && (
                                        <ReviewDashboard />
                                    )}
                                    
                                    {activeTab === 'visualize' && (
                                        <VisualizeTab 
                                            data={pipelineState}
                                        />
                                    )}
                                </>
                            )}
                        </div>

                        {/* Enhanced Console */}
                        {showConsole && (
                            <div style={{
                                position: 'fixed',
                                bottom: 0,
                                left: 380,
                                right: 0,
                                height: '400px',
                                background: '#0a0e1a',
                                borderTop: '2px solid #2d3548',
                                display: 'flex',
                                flexDirection: 'column',
                                boxShadow: '0 -5px 20px rgba(0, 0, 0, 0.3)'
                            }}>
                                <div style={{
                                    padding: '15px 25px',
                                    background: '#1a1f2e',
                                    borderBottom: '1px solid #2d3548',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <h3 style={{margin: 0, fontSize: '1.1em', display: 'flex', alignItems: 'center', gap: '10px'}}>
                                        <span>üñ•Ô∏è</span> Console Output
                                        {loading && (
                                            <span style={{marginLeft: '20px', color: '#8b5cf6', fontSize: '0.9em'}}>
                                                <span className="loading-spinner" style={{
                                                    width: '16px',
                                                    height: '16px',
                                                    display: 'inline-block',
                                                    marginRight: '10px',
                                                    verticalAlign: 'middle'
                                                }}></span>
                                                {currentOperation}
                                            </span>
                                        )}
                                    </h3>
                                    <div style={{display: 'flex', gap: '10px'}}>
                                        <span style={{fontSize: '0.85em', color: '#9ca3af'}}>
                                            {pipelineState.logs.length} entries
                                        </span>
                                        <button 
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => setPipelineState(prev => ({ ...prev, logs: [] }))}
                                        >
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                <div className="console" style={{
                                    flex: 1,
                                    overflow: 'auto',
                                    padding: '20px',
                                }}>
                                    {pipelineState.logs.map((log, index) => (
                                        <div key={index} className="console-line">
                                            <span className="console-timestamp">
                                                [{new Date(log.timestamp).toLocaleTimeString()}]
                                            </span>
                                            <span className={`console-message console-${log.type}`}>
                                                {log.message}
                                            </span>
                                        </div>
                                    ))}
                                    <div ref={logEndRef} />
                                </div>
                            </div>
                        )}
                    </div>

                    {loading && (
                        <LoadingOverlay currentOperation={currentOperation} />
                    )}
                </div>
            );
        };

        // Configuration Tab Component
        const ConfigurationTab = ({ configuration, onUpdate, onRefresh }) => {
            const [localConfig, setLocalConfig] = React.useState(configuration);
            const [hasChanges, setHasChanges] = React.useState(false);

            React.useEffect(() => {
                setLocalConfig(configuration);
            }, [configuration]);

            const handleChange = (field, value) => {
                setLocalConfig(prev => ({
                    ...prev,
                    [field]: value
                }));
                setHasChanges(true);
            };

            const handleSave = () => {
                onUpdate(localConfig);
                setHasChanges(false);
            };

            return (
                <div>
                    <div className="card">
                        <div className="card-header">
                            <h2>Pipeline Configuration</h2>
                            <div style={{display: 'flex', gap: '10px'}}>
                                <button className="btn btn-secondary" onClick={onRefresh}>
                                    üîÑ Refresh
                                </button>
                                <button 
                                    className="btn btn-primary" 
                                    onClick={handleSave}
                                    disabled={!hasChanges}
                                >
                                    üíæ Save Changes
                                </button>
                            </div>
                        </div>

                        {/* LLM Configuration */}
                        <div className="config-panel" style={{background: '#0a0e1a', border: '2px solid #2d3548', borderRadius: '12px', padding: '25px', marginBottom: '25px'}}>
                            <h3 style={{marginBottom: '20px'}}>ü§ñ Language Model Settings</h3>
                            <div className="config-grid" style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px', marginTop: '20px'}}>
                                <div className="form-group">
                                    <label className="form-label">LLM Provider</label>
                                    <select 
                                        className="form-control"
                                        value={localConfig.llm_provider}
                                        onChange={(e) => handleChange('llm_provider', e.target.value)}
                                    >
                                        <option value="scaleway">Scaleway</option>
                                        <option value="ollama">Local Ollama</option>
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Model</label>
                                    <input 
                                        type="text"
                                        className="form-control"
                                        value={localConfig.llm_model}
                                        onChange={(e) => handleChange('llm_model', e.target.value)}
                                        placeholder="llama-3.3-70b-instruct"
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Timeout (seconds)</label>
                                    <input 
                                        type="number"
                                        className="form-control"
                                        value={localConfig.timeout}
                                        onChange={(e) => handleChange('timeout', parseInt(e.target.value))}
                                        min="60"
                                        max="10000"
                                    />
                                </div>
                            </div>

                            {localConfig.llm_provider === 'ollama' && (
                                <div className="form-group" style={{marginTop: '20px'}}>
                                    <label className="form-label">Local LLM Endpoint</label>
                                    <input 
                                        type="text"
                                        className="form-control"
                                        value={localConfig.local_llm_endpoint}
                                        onChange={(e) => handleChange('local_llm_endpoint', e.target.value)}
                                        placeholder="http://localhost:11434/api/generate"
                                    />
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Enhanced Pipeline Step Component
        const PipelineStep = ({ step, index, active, hasReview, onClick }) => {
            const icons = ['üìÑ', 'üîó', '‚ö†Ô∏è', '‚ú®', 'üéØ'];
            
            return (
                <div 
                    className={`pipeline-step ${active ? 'active' : ''} ${step.status} ${hasReview ? 'has-review' : ''}`}
                    onClick={onClick}
                >
                    <div className="step-title">
                        <span style={{fontSize: '1.2em'}}>{icons[index]}</span>
                        {step.name}
                        {step.status === 'running' && (
                            <span className="loading-spinner" style={{width: '16px', height: '16px'}} />
                        )}
                    </div>
                    <div style={{fontSize: '0.85em', color: '#9ca3af'}}>
                        {step.status === 'completed' && `${step.data?.count || 0} items`}
                        {step.status === 'error' && 'Failed - Click to retry'}
                        {step.status === 'pending' && 'Ready to run'}
                        {step.status === 'running' && 'Processing...'}
                        {hasReview && ' - Review needed'}
                    </div>
                    {step.status === 'running' && (
                        <div style={{marginTop: '8px'}}>
                            <div className="progress-bar">
                                <div className="progress-bar-fill" style={{width: '60%'}}></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Enhanced Overview Tab
        const OverviewTab = ({ step, pipelineState, currentStep, onUpload, onRunStep }) => {
            if (!step) return null;

            if (step.id === 1 && step.status === 'pending') {
                return <FileUploadComponent onUpload={onUpload} />;
            }

            const prevStepCompleted = currentStep > 0 ? pipelineState.steps[currentStep - 1]?.status === 'completed' : true;
            const canRunStep = step.status === 'pending' && prevStepCompleted;

            return (
                <div className="card">
                    <div className="card-header">
                        <h2>{step.name}</h2>
                        <div style={{display: 'flex', gap: '15px'}}>
                            {canRunStep && (
                                <button className="btn btn-primary" onClick={onRunStep}>
                                    ‚ñ∂Ô∏è Run This Step
                                </button>
                            )}
                            {step.status === 'completed' && (
                                <button className="btn btn-secondary" onClick={onRunStep}>
                                    üîÑ Re-run Step
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {step.data && (
                        <div>
                            <p style={{marginBottom: '20px', fontSize: '1.05em'}}>
                                Step completed successfully. Review the data or proceed to the next step.
                            </p>
                            <div className="json-viewer" style={{maxHeight: '400px'}}>
                                <pre dangerouslySetInnerHTML={{__html: highlightJSON(step.data)}} />
                            </div>
                        </div>
                    )}
                    
                    {!step.data && step.status === 'pending' && (
                        <div style={{textAlign: 'center', padding: '60px 20px'}}>
                            {prevStepCompleted ? (
                                <>
                                    <div style={{fontSize: '3em', marginBottom: '20px', opacity: 0.8}}>
                                        {['üìÑ', 'üîó', '‚ö†Ô∏è', '‚ú®', 'üéØ'][currentStep]}
                                    </div>
                                    <p style={{fontSize: '1.2em', marginBottom: '10px'}}>Ready to run this step</p>
                                    <p style={{color: '#9ca3af'}}>Click "Run This Step" to {step.name.toLowerCase()}</p>
                                </>
                            ) : (
                                <>
                                    <div style={{fontSize: '3em', marginBottom: '20px', opacity: 0.5}}>üîí</div>
                                    <p style={{fontSize: '1.2em', color: '#9ca3af'}}>Please complete the previous steps first</p>
                                </>
                            )}
                        </div>
                    )}
                    
                    {step.status === 'error' && (
                        <div className="card" style={{background: 'rgba(239, 68, 68, 0.1)', borderColor: '#ef4444'}}>
                            <p style={{color: '#f87171', marginBottom: '15px'}}>
                                ‚ö†Ô∏è This step failed. Check the console for errors and try again.
                            </p>
                            <button className="btn btn-danger" onClick={onRunStep}>
                                Retry Step
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // File Upload Component
        const FileUploadComponent = ({ onUpload }) => {
            const [dragging, setDragging] = React.useState(false);
            const [inputMethod, setInputMethod] = React.useState('upload');
            const [textContent, setTextContent] = React.useState('');
            const [isProcessing, setIsProcessing] = React.useState(false);

            const handleDrop = (e) => {
                e.preventDefault();
                setDragging(false);
                if (e.dataTransfer.files.length) {
                    onUpload(e.dataTransfer.files);
                }
            };

            const handleTextSubmit = async () => {
                if (!textContent.trim()) {
                    alert('Please enter some text');
                    return;
                }
                
                setIsProcessing(true);
                const blob = new Blob([textContent], { type: 'text/plain' });
                const file = new File([blob], 'manual_input.txt', { type: 'text/plain' });
                
                await onUpload([file]);
                setIsProcessing(false);
            };

            const sampleTexts = {
                ecommerce: `System: E-Commerce Platform, Version 2.1, Retail Industry
External Entities: User (U), Payment Gateway (PG), Admin (A)
Assets: Customer Database (DB_C), Product Database (DB_P), Session Store (CACHE)
Processes: Web Server (WS), API Gateway (API), Payment Processor (PP), Admin Portal (AP)
Trust Boundaries: Internet to DMZ, DMZ to Internal Network, Internal to Database Zone
Data Flows:
- From User to Web Server: Login credentials and session tokens, Confidential, HTTPS, JWT Authentication
- From Web Server to API Gateway: API requests with user context, Confidential, HTTPS, mTLS
- From API Gateway to Customer Database: Customer queries and updates, PII, TLS, Database credentials
- From Payment Processor to Payment Gateway: Payment transactions, PCI, HTTPS, API Key authentication
- From Admin to Admin Portal: Administrative commands, Confidential, HTTPS, MFA required`,
                
                healthcare: `System: Healthcare Management System, Version 1.0, Healthcare Industry
External Entities: Patient (P), Healthcare Provider (HP), Insurance Company (IC)
Assets: Patient Records Database (DB_PR), Medical Images Store (IMG), Audit Logs (LOGS)
Processes: Patient Portal (PP), Clinical System (CS), Billing System (BS), Integration Engine (IE)
Trust Boundaries: Public Internet to Application Layer, Application to Data Layer, External Partners
Data Flows:
- From Patient to Patient Portal: Health information and appointment requests, PHI, HTTPS, SAML SSO
- From Healthcare Provider to Clinical System: Medical records and prescriptions, PHI, HTTPS, Smart Card Auth
- From Clinical System to Patient Records Database: Patient data storage, PHI, TLS, Encrypted at rest
- From Integration Engine to Insurance Company: Claims data, PHI/PII, HTTPS, OAuth 2.0
- From All Systems to Audit Logs: Compliance logging, Internal, TLS, Service Account`
            };

            return (
                <div className="card">
                    <div className="card-header">
                        <h2>Input System Description</h2>
                    </div>
                    
                    <div className="tabs">
                        <button 
                            className={`tab ${inputMethod === 'upload' ? 'active' : ''}`}
                            onClick={() => setInputMethod('upload')}
                        >
                            üìÅ Upload File
                        </button>
                        <button 
                            className={`tab ${inputMethod === 'text' ? 'active' : ''}`}
                            onClick={() => setInputMethod('text')}
                        >
                            ‚úèÔ∏è Enter Text
                        </button>
                        <button 
                            className={`tab ${inputMethod === 'sample' ? 'active' : ''}`}
                            onClick={() => setInputMethod('sample')}
                        >
                            üìã Use Sample
                        </button>
                    </div>

                    {inputMethod === 'upload' && (
                        <div 
                            className={`file-upload ${dragging ? 'dragging' : ''}`}
                            onDrop={handleDrop}
                            onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
                            onDragLeave={() => setDragging(false)}
                            onClick={() => document.getElementById('fileInput').click()}
                            style={{
                                border: '3px dashed #2d3548',
                                borderRadius: '12px',
                                padding: '60px',
                                textAlign: 'center',
                                transition: 'all 0.3s ease',
                                cursor: 'pointer',
                                background: dragging ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.02)'
                            }}
                        >
                            <input 
                                type="file" 
                                id="fileInput" 
                                style={{display: 'none'}}
                                onChange={(e) => onUpload(e.target.files)}
                                accept=".txt,.pdf,.doc,.docx"
                            />
                            <div style={{fontSize: '4em', marginBottom: '20px', opacity: 0.8}}>üìÅ</div>
                            <div style={{fontSize: '1.2em', marginBottom: '10px', fontWeight: '500'}}>
                                Drop files here or click to browse
                            </div>
                            <div style={{fontSize: '0.95em', color: '#9ca3af'}}>
                                Supports TXT, PDF, DOC, DOCX
                            </div>
                        </div>
                    )}

                    {inputMethod === 'text' && (
                        <div>
                            <div className="form-group">
                                <label className="form-label">System Description</label>
                                <textarea 
                                    className="form-control"
                                    rows={15}
                                    placeholder="Enter your system description here..."
                                    value={textContent}
                                    onChange={(e) => setTextContent(e.target.value)}
                                />
                            </div>
                            <button 
                                className="btn btn-primary"
                                onClick={handleTextSubmit}
                                disabled={isProcessing || !textContent.trim()}
                            >
                                {isProcessing ? 'Processing...' : 'Process Text'}
                            </button>
                        </div>
                    )}

                    {inputMethod === 'sample' && (
                        <div>
                            <div className="form-group">
                                <label className="form-label">Select Sample System</label>
                                <select 
                                    className="form-control"
                                    onChange={(e) => setTextContent(sampleTexts[e.target.value] || '')}
                                    defaultValue=""
                                >
                                    <option value="" disabled>Choose a sample...</option>
                                    <option value="ecommerce">E-Commerce Platform</option>
                                    <option value="healthcare">Healthcare Management System</option>
                                </select>
                            </div>
                            
                            {textContent && (
                                <>
                                    <div className="form-group">
                                        <label className="form-label">Sample Content (Editable)</label>
                                        <textarea 
                                            className="form-control"
                                            rows={12}
                                            value={textContent}
                                            onChange={(e) => setTextContent(e.target.value)}
                                        />
                                    </div>
                                    <button 
                                        className="btn btn-primary"
                                        onClick={handleTextSubmit}
                                        disabled={isProcessing}
                                    >
                                        {isProcessing ? 'Processing...' : 'Use This Sample'}
                                    </button>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // Enhanced Step Review Screen Component
        const StepReviewScreen = ({ stepReview, stepName, onAccept, onEdit, reviewMode, setReviewMode, needsExpertReview }) => {
            const [reviewData, setReviewData] = React.useState(stepReview.data);

            const renderSummary = () => {
                switch (stepReview.stepIndex) {
                    case 0: // Upload
                        return (
                            <div>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '25px'}}>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#8b5cf6', marginBottom: '5px'}}>
                                            {reviewData.text_length}
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            Characters Extracted
                                        </div>
                                    </div>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#10b981', marginBottom: '5px'}}>
                                            ‚úì
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            Document Processed
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    
                    case 1: // DFD
                        const dfd = reviewData.dfd || {};
                        return (
                            <div>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '20px', marginBottom: '25px'}}>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#3b82f6', marginBottom: '5px'}}>
                                            {dfd.external_entities?.length || 0}
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            External Entities
                                        </div>
                                    </div>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#8b5cf6', marginBottom: '5px'}}>
                                            {dfd.processes?.length || 0}
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            Processes
                                        </div>
                                    </div>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#10b981', marginBottom: '5px'}}>
                                            {dfd.assets?.length || 0}
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            Assets
                                        </div>
                                    </div>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#f59e0b', marginBottom: '5px'}}>
                                            {dfd.data_flows?.length || 0}
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            Data Flows
                                        </div>
                                    </div>
                                </div>
                                <div className="card" style={{background: '#0a0e1a'}}>
                                    <h3 style={{marginBottom: '15px'}}>üè¢ Project Information</h3>
                                    <p><strong>Project:</strong> {dfd.project_name} (v{dfd.project_version})</p>
                                    <p><strong>Industry:</strong> {dfd.industry_context}</p>
                                </div>
                            </div>
                        );
                    
                    case 2: // Threats
                    case 3: // Refined Threats
                        const threats = reviewData.threats || [];
                        const byCategory = threats.reduce((acc, t) => {
                            acc[t.stride_category] = (acc[t.stride_category] || 0) + 1;
                            return acc;
                        }, {});
                        const byRisk = threats.reduce((acc, t) => {
                            acc[t.risk_score || t.impact] = (acc[t.risk_score || t.impact] || 0) + 1;
                            return acc;
                        }, {});
                        
                        return (
                            <div>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '20px', marginBottom: '25px'}}>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#8b5cf6', marginBottom: '5px'}}>
                                            {threats.length}
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            Total Threats
                                        </div>
                                    </div>
                                    {Object.entries(byRisk).map(([risk, count]) => (
                                        <div key={risk} className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                            <div style={{
                                                fontSize: '2em', 
                                                fontWeight: '700', 
                                                color: risk === 'Critical' ? '#ef4444' :
                                                       risk === 'High' ? '#f59e0b' :
                                                       risk === 'Medium' ? '#3b82f6' : '#10b981',
                                                marginBottom: '5px'
                                            }}>
                                                {count}
                                            </div>
                                            <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                                {risk} Risk
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="card" style={{background: '#0a0e1a'}}>
                                    <h3 style={{marginBottom: '15px'}}>üéØ STRIDE Distribution</h3>
                                    <div style={{display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                                        {Object.entries(byCategory).map(([cat, count]) => (
                                            <div key={cat} style={{padding: '10px 20px', background: '#1a1f2e', borderRadius: '8px', border: '1px solid #2d3548'}}>
                                                <strong>{cat}:</strong> {count}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        );
                    
                    case 4: // Attack Paths
                        const paths = reviewData.attack_paths || [];
                        return (
                            <div>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '25px'}}>
                                    <div className="card" style={{background: '#0a0e1a', textAlign: 'center'}}>
                                        <div style={{fontSize: '2em', fontWeight: '700', color: '#8b5cf6', marginBottom: '5px'}}>
                                            {paths.length}
                                        </div>
                                        <div style={{fontSize: '0.9em', color: '#9ca3af', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                            Attack Paths
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    
                    default:
                        return <p>No summary available</p>;
                }
            };

            return (
                <div style={{
                    background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%)',
                    border: '2px solid #8b5cf6',
                    borderRadius: '16px',
                    padding: '30px',
                    marginBottom: '30px',
                    boxShadow: '0 10px 40px rgba(139, 92, 246, 0.2)'
                }}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '15px', marginBottom: '25px'}}>
                        <h2 style={{fontSize: '1.6em', margin: 0}}>üìã Review: {stepName} Output</h2>
                        <span className="tag tag-warning">Pending Review</span>
                    </div>
                    
                    {needsExpertReview && (
                        <div style={{marginBottom: '20px', padding: '15px', background: 'rgba(245, 158, 11, 0.1)', borderRadius: '8px'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                                <span className="tag tag-warning">{needsExpertReview} Items Need Review</span>
                                <span>Some extracted items have low confidence and need expert validation</span>
                                <button 
                                    className="btn btn-warning btn-sm"
                                    onClick={() => setReviewMode(reviewMode === 'summary' ? 'expert' : 'summary')}
                                >
                                    {reviewMode === 'summary' ? 'Start Expert Review' : 'Back to Summary'}
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {reviewMode === 'expert' ? (
                        <ReviewInterface 
                            stepReview={stepReview}
                            onComplete={() => {
                                setReviewMode('summary');
                                // Refresh to check if more reviews needed
                                window.location.reload();
                            }}
                        />
                    ) : (
                        <>
                            {renderSummary()}
                            
                            <div className="card" style={{marginTop: '20px', background: '#0a0e1a'}}>
                                <div className="card-header">
                                    <h3>üîç Raw Data Preview</h3>
                                </div>
                                <div className="json-viewer" style={{maxHeight: '400px'}}>
                                    <pre dangerouslySetInnerHTML={{__html: highlightJSON(reviewData)}} />
                                </div>
                            </div>
                            
                            <div style={{display: 'flex', gap: '15px', marginTop: '30px', flexWrap: 'wrap'}}>
                                <button 
                                    className="btn btn-success"
                                    onClick={() => onAccept(reviewData, false)}
                                >
                                    ‚úì Accept & View Next Step
                                </button>
                                <button 
                                    className="btn btn-primary"
                                    onClick={() => onAccept(reviewData, true)}
                                >
                                    ‚ö° Accept & Run Next Step
                                </button>
                                <button 
                                    className="btn btn-warning"
                                    onClick={onEdit}
                                >
                                    üõ†Ô∏è Advanced Editor
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // Enhanced Edit Tab Component
        const EditTab = ({ step, viewMode }) => {
            if (!step || !step.data) {
                return (
                    <div className="card" style={{textAlign: 'center', padding: '60px'}}>
                        <div style={{fontSize: '3em', marginBottom: '20px', opacity: 0.5}}>üìù</div>
                        <p style={{fontSize: '1.2em', color: '#9ca3af'}}>No data to edit</p>
                        <p>Run the pipeline first to generate data</p>
                    </div>
                );
            }

            return (
                <div className="card" style={{height: 'calc(100vh - 200px)', display: 'flex', flexDirection: 'column'}}>
                    <div className="card-header">
                        <h2>Edit {step.name} Data</h2>
                    </div>
                    <div className="json-viewer" style={{flex: 1}}>
                        <pre dangerouslySetInnerHTML={{__html: highlightJSON(step.data)}} />
                    </div>
                </div>
            );
        };

        // Visualize Tab Component
        const VisualizeTab = ({ data }) => {
            return (
                <div className="card">
                    <div className="card-header">
                        <h2>Visualizations</h2>
                    </div>
                    <p style={{textAlign: 'center', padding: '60px', color: '#9ca3af'}}>
                        Visualization features are not yet implemented. 
                        Please use the Edit tab to view and modify data.
                    </p>
                </div>
            );
        };

        const LoadingOverlay = ({ currentOperation }) => (
            <div className="loading-overlay">
                <div className="loading-content" style={{
                    background: '#1a1f2e',
                    padding: '40px',
                    borderRadius: '16px',
                    textAlign: 'center',
                    boxShadow: '0 10px 40px rgba(0, 0, 0, 0.5)',
                    maxWidth: '500px'
                }}>
                    <div className="loading-spinner" style={{width: '60px', height: '60px', borderWidth: '4px'}}></div>
                    <p style={{marginTop: '30px', fontSize: '1.2em', marginBottom: '15px'}}>Processing...</p>
                    {currentOperation && (
                        <p style={{color: '#9ca3af', fontSize: '1em', maxWidth: '500px', textAlign: 'center', lineHeight: 1.6}}>
                            {currentOperation}
                        </p>
                    )}
                </div>
            </div>
        );

        // Render the app
        ReactDOM.render(<ThreatModelingApp />, document.getElementById('root'));
    </script>
</body>
</html>