<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Modeling Pipeline Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            color: #9ca3af;
            font-size: 1.1em;
            position: relative;
            z-index: 1;
        }

        /* Pipeline Steps */
        .pipeline-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .pipeline-step {
            flex: 1;
            min-width: 280px;
            background: #1a1a1a;
            border: 2px solid #2d2d2d;
            border-radius: 12px;
            padding: 25px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pipeline-step:hover {
            transform: translateY(-5px);
            border-color: #8b5cf6;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        }

        .pipeline-step.active {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b4e 100%);
        }

        .pipeline-step.completed {
            border-color: #10b981;
        }

        .pipeline-step.error {
            border-color: #ef4444;
        }

        .step-number {
            position: absolute;
            top: -15px;
            left: 20px;
            background: #8b5cf6;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .step-icon {
            font-size: 2em;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        .step-description {
            color: #9ca3af;
            font-size: 0.95em;
            margin-bottom: 15px;
        }

        .step-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4b5563;
            animation: blink 2s infinite;
        }

        .status-indicator.running {
            background: #fbbf24;
            animation: pulse-dot 1.5s infinite;
        }

        .status-indicator.completed {
            background: #10b981;
            animation: none;
        }

        .status-indicator.error {
            background: #ef4444;
            animation: pulse-dot 1s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* Content Area */
        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #1a1a1a;
            border: 1px solid #2d2d2d;
            border-radius: 12px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2d2d2d;
        }

        .panel-title {
            font-size: 1.4em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-actions {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: #374151;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #d1d5db;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            background: #0a0a0a;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Data Display */
        .data-grid {
            display: grid;
            gap: 15px;
        }

        .data-item {
            background: #0a0a0a;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            border-color: #4b5563;
            transform: translateX(5px);
        }

        .data-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .data-item-title {
            font-weight: bold;
            color: #e0e0e0;
        }

        .data-item-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .meta-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            background: #374151;
            color: #d1d5db;
        }

        .meta-tag.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .meta-tag.high {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .meta-tag.medium {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .meta-tag.low {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Attack Path Visualization */
        .attack-path {
            background: #0a0a0a;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .attack-path-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .attack-path-steps {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .path-step {
            background: #1a1a1a;
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 10px 15px;
            min-width: 150px;
            text-align: center;
            position: relative;
        }

        .path-step::after {
            content: '‚Üí';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #4b5563;
            font-size: 1.2em;
        }

        .path-step:last-child::after {
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #374151;
            padding-bottom: 10px;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px 6px 0 0;
            position: relative;
        }

        .tab:hover {
            color: #e0e0e0;
            background: rgba(139, 92, 246, 0.1);
        }

        .tab.active {
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 0;
            right: 0;
            height: 2px;
            background: #8b5cf6;
        }

        /* Loading and States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #9ca3af;
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid #374151;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #ef4444;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: #4b5563;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #8b5cf6;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.9em;
        }

        /* Search and Filters */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            background: #0a0a0a;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.95em;
        }

        .search-input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pipeline-container {
                flex-direction: column;
            }

            .content-area {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üõ°Ô∏è Threat Modeling Pipeline Visualizer</h1>
            <p>Interactive tool for reviewing and managing threat modeling analysis</p>
        </div>

        <!-- Pipeline Steps -->
        <div class="pipeline-container">
            <div class="pipeline-step" id="step-1" onclick="selectStep(1)">
                <span class="step-number">Step 1</span>
                <div class="step-icon">üìÑ</div>
                <div class="step-title">Info to DFDs</div>
                <div class="step-description">Extract DFD components from documents</div>
                <div class="step-status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Ready</span>
                </div>
            </div>

            <div class="pipeline-step" id="step-2" onclick="selectStep(2)">
                <span class="step-number">Step 2</span>
                <div class="step-icon">‚ö†Ô∏è</div>
                <div class="step-title">DFD to Threats</div>
                <div class="step-description">Generate threats using STRIDE</div>
                <div class="step-status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Waiting</span>
                </div>
            </div>

            <div class="pipeline-step" id="step-3" onclick="selectStep(3)">
                <span class="step-number">Step 3</span>
                <div class="step-icon">‚ú®</div>
                <div class="step-title">Improve Quality</div>
                <div class="step-description">Refine and deduplicate threats</div>
                <div class="step-status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Waiting</span>
                </div>
            </div>

            <div class="pipeline-step" id="step-4" onclick="selectStep(4)">
                <span class="step-number">Step 4</span>
                <div class="step-icon">üéØ</div>
                <div class="step-title">Attack Paths</div>
                <div class="step-description">Analyze attack path scenarios</div>
                <div class="step-status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Waiting</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Left Panel - Input/Configuration -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span id="left-panel-icon">‚öôÔ∏è</span>
                        <span id="left-panel-title">Configuration</span>
                    </h2>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-sm" onclick="loadSampleData()">
                            Load Sample
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="saveConfiguration()">
                            Save
                        </button>
                    </div>
                </div>
                <div id="left-panel-content">
                    <!-- Content will be dynamically loaded based on selected step -->
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Select a pipeline step to configure</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Output/Results -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span id="right-panel-icon">üìä</span>
                        <span id="right-panel-title">Results</span>
                    </h2>
                    <div class="panel-actions">
                        <button class="btn btn-secondary btn-sm" onclick="exportResults()">
                            Export
                        </button>
                        <button class="btn btn-success btn-sm" onclick="validateResults()">
                            Validate
                        </button>
                    </div>
                </div>
                <div id="right-panel-content">
                    <!-- Results will be displayed here -->
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <p>Results will appear here after processing</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Dashboard -->
        <div class="panel" style="margin-bottom: 30px;">
            <div class="panel-header">
                <h2 class="panel-title">üìä Pipeline Statistics</h2>
            </div>
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-components">0</div>
                    <div class="stat-label">Components</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-threats">0</div>
                    <div class="stat-label">Threats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-critical">0</div>
                    <div class="stat-label">Critical</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-paths">0</div>
                    <div class="stat-label">Attack Paths</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for editing -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Edit Item</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let pipelineData = {
            dfd: null,
            threats: [],
            refinedThreats: [],
            attackPaths: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            selectStep(1);
            updateStatistics();
        });

        // Step selection
        function selectStep(step) {
            currentStep = step;
            
            // Update visual state
            document.querySelectorAll('.pipeline-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Update panels based on step
            updatePanels(step);
        }

        // Update panels based on selected step
        function updatePanels(step) {
            const leftPanel = document.getElementById('left-panel-content');
            const rightPanel = document.getElementById('right-panel-content');
            const leftTitle = document.getElementById('left-panel-title');
            const rightTitle = document.getElementById('right-panel-title');
            const leftIcon = document.getElementById('left-panel-icon');
            const rightIcon = document.getElementById('right-panel-icon');
            
            switch(step) {
                case 1:
                    leftTitle.textContent = 'DFD Configuration';
                    leftIcon.textContent = 'üìÑ';
                    rightTitle.textContent = 'DFD Components';
                    rightIcon.textContent = 'üîó';
                    renderDFDConfiguration(leftPanel);
                    renderDFDComponents(rightPanel);
                    break;
                    
                case 2:
                    leftTitle.textContent = 'Threat Generation';
                    leftIcon.textContent = '‚ö†Ô∏è';
                    rightTitle.textContent = 'Identified Threats';
                    rightIcon.textContent = 'üîç';
                    renderThreatConfiguration(leftPanel);
                    renderThreats(rightPanel);
                    break;
                    
                case 3:
                    leftTitle.textContent = 'Quality Settings';
                    leftIcon.textContent = '‚ú®';
                    rightTitle.textContent = 'Refined Threats';
                    rightIcon.textContent = 'üíé';
                    renderQualityConfiguration(leftPanel);
                    renderRefinedThreats(rightPanel);
                    break;
                    
                case 4:
                    leftTitle.textContent = 'Attack Path Analysis';
                    leftIcon.textContent = 'üéØ';
                    rightTitle.textContent = 'Attack Scenarios';
                    rightIcon.textContent = 'üõ§Ô∏è';
                    renderAttackPathConfiguration(leftPanel);
                    renderAttackPaths(rightPanel);
                    break;
            }
        }

        // Render DFD Configuration
        function renderDFDConfiguration(container) {
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="projectName" 
                           placeholder="e.g., E-Commerce Platform" value="${pipelineData.dfd?.project_name || ''}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Industry Context</label>
                    <select class="form-control" id="industryContext">
                        <option value="Finance">Finance</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Retail">Retail</option>
                        <option value="Technology">Technology</option>
                        <option value="Government">Government</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">External Entities</label>
                    <textarea class="form-control" id="externalEntities" 
                              placeholder="Enter entities, one per line">U (User)
External Attacker
Third-party API</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Processes</label>
                    <textarea class="form-control" id="processes" 
                              placeholder="Enter processes, one per line">Web Server (WS)
API Gateway (API)
Database Server (DB)</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Data Stores</label>
                    <textarea class="form-control" id="dataStores" 
                              placeholder="Enter data stores, one per line">User Database (DB_U)
Session Store (CACHE)
File Storage (FS)</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="generateDFD()">
                    Generate DFD
                </button>
            `;
        }

        // Render DFD Components
        function renderDFDComponents(container) {
            if (!pipelineData.dfd) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîó</div>
                        <p>No DFD components generated yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="tabs">
                    <button class="tab active" onclick="showDFDTab('overview')">Overview</button>
                    <button class="tab" onclick="showDFDTab('flows')">Data Flows</button>
                    <button class="tab" onclick="showDFDTab('boundaries')">Trust Boundaries</button>
                </div>
                
                <div id="dfd-tab-content">
                    ${renderDFDOverview()}
                </div>
            `;
        }

        // Render Threat Configuration
        function renderThreatConfiguration(container) {
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">LLM Provider</label>
                    <select class="form-control" id="llmProvider">
                        <option value="scaleway">Scaleway</option>
                        <option value="ollama">Ollama (Local)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Model</label>
                    <input type="text" class="form-control" id="llmModel" 
                           value="llama-3.3-70b-instruct">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Enable Web Search</label>
                    <select class="form-control" id="enableWebSearch">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Enable Qdrant</label>
                    <select class="form-control" id="enableQdrant">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Focus Areas</label>
                    <div style="display: grid; gap: 10px;">
                        <label><input type="checkbox" checked> Authentication & Authorization</label>
                        <label><input type="checkbox" checked> Data Protection</label>
                        <label><input type="checkbox" checked> Input Validation</label>
                        <label><input type="checkbox"> Network Security</label>
                        <label><input type="checkbox"> Cryptography</label>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generateThreats()">
                    Generate Threats
                </button>
            `;
        }

        // Render Threats
        function renderThreats(container) {
            if (!pipelineData.threats || pipelineData.threats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>No threats generated yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search threats..." 
                           onkeyup="filterThreats(this.value)">
                    <select class="form-control" style="width: 150px;" onchange="filterByCategory(this.value)">
                        <option value="">All Categories</option>
                        <option value="S">Spoofing</option>
                        <option value="T">Tampering</option>
                        <option value="R">Repudiation</option>
                        <option value="I">Information Disclosure</option>
                        <option value="D">Denial of Service</option>
                        <option value="E">Elevation of Privilege</option>
                    </select>
                </div>
                
                <div class="data-grid" id="threats-list">
                    ${pipelineData.threats.map((threat, index) => renderThreatItem(threat, index)).join('')}
                </div>
            `;
        }

        // Render single threat item
        function renderThreatItem(threat, index) {
            const strideMap = {
                'S': 'Spoofing',
                'T': 'Tampering',
                'R': 'Repudiation',
                'I': 'Information Disclosure',
                'D': 'Denial of Service',
                'E': 'Elevation of Privilege'
            };
            
            return `
                <div class="data-item slide-in" data-threat-id="${index}">
                    <div class="data-item-header">
                        <div class="data-item-title">${threat.component_name}</div>
                        <button class="btn btn-secondary btn-sm" onclick="editThreat(${index})">
                            Edit
                        </button>
                    </div>
                    <div class="data-item-meta">
                        <span class="meta-tag">${strideMap[threat.stride_category] || threat.stride_category}</span>
                        <span class="meta-tag ${threat.impact.toLowerCase()}">${threat.impact}</span>
                        <span class="meta-tag">Likelihood: ${threat.likelihood}</span>
                    </div>
                    <p style="margin-bottom: 10px;">${threat.threat_description}</p>
                    <p style="color: #9ca3af; font-size: 0.9em;">
                        <strong>Mitigation:</strong> ${threat.mitigation_suggestion}
                    </p>
                </div>
            `;
        }

        // Render Quality Configuration
        function renderQualityConfiguration(container) {
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Similarity Threshold</label>
                    <input type="range" class="form-control" id="similarityThreshold" 
                           min="0.5" max="1.0" step="0.05" value="0.8"
                           oninput="document.getElementById('simValue').textContent = this.value">
                    <small>Current: <span id="simValue">0.8</span></small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">CVE Relevance (Years)</label>
                    <input type="number" class="form-control" id="cveYears" 
                           value="5" min="1" max="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Suppression Rules</label>
                    <div style="display: grid; gap: 10px;">
                        <label><input type="checkbox" checked> Suppress duplicates</label>
                        <label><input type="checkbox" checked> Remove outdated CVEs</label>
                        <label><input type="checkbox"> Suppress low impact + low likelihood</label>
                        <label><input type="checkbox"> Remove theoretical threats</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Controls in Place</label>
                    <div style="display: grid; gap: 10px;">
                        <label><input type="checkbox"> mTLS enabled</label>
                        <label><input type="checkbox"> WAF deployed</label>
                        <label><input type="checkbox"> Secrets Manager</label>
                        <label><input type="checkbox"> Rate Limiting</label>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="refineThreats()">
                    Refine Threats
                </button>
            `;
        }

        // Render Attack Path Configuration
        function renderAttackPathConfiguration(container) {
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Max Path Length</label>
                    <input type="number" class="form-control" id="maxPathLength" 
                           value="5" min="2" max="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Analysis Focus</label>
                    <select class="form-control" id="analysisFocus">
                        <option value="critical">Critical Assets Only</option>
                        <option value="all">All Components</option>
                        <option value="external">External Entry Points</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Enable LLM Enrichment</label>
                    <select class="form-control" id="enableEnrichment">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Vector Store</label>
                    <select class="form-control" id="enableVectorStore">
                        <option value="true">Enable Cross-Project Intelligence</option>
                        <option value="false">Disable</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="analyzeAttackPaths()">
                    Analyze Attack Paths
                </button>
            `;
        }

        // Render Attack Paths
        function renderAttackPaths(container) {
            if (!pipelineData.attackPaths || pipelineData.attackPaths.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõ§Ô∏è</div>
                        <p>No attack paths analyzed yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="tabs">
                    <button class="tab active" onclick="showAttackTab('paths')">Attack Paths</button>
                    <button class="tab" onclick="showAttackTab('defenses')">Defense Priorities</button>
                    <button class="tab" onclick="showAttackTab('insights')">Insights</button>
                </div>
                
                <div id="attack-tab-content">
                    ${renderAttackPathsList()}
                </div>
            `;
        }

        // Render Attack Paths List
        function renderAttackPathsList() {
            return pipelineData.attackPaths.map((path, index) => `
                <div class="attack-path fade-in">
                    <div class="attack-path-header">
                        <div>
                            <h3>${path.scenario_name}</h3>
                            <div class="data-item-meta">
                                <span class="meta-tag ${path.combined_impact.toLowerCase()}">${path.combined_impact} Impact</span>
                                <span class="meta-tag">${path.path_feasibility}</span>
                                <span class="meta-tag">${path.time_to_compromise}</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="viewPathDetails(${index})">
                            View Details
                        </button>
                    </div>
                    <div class="attack-path-steps">
                        ${path.path_steps.map(step => `
                            <div class="path-step">
                                <div style="font-weight: bold;">${step.component}</div>
                                <div style="font-size: 0.85em; color: #9ca3af;">${step.stride_category}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function generateDFD() {
            // Simulate DFD generation
            const projectName = document.getElementById('projectName').value;
            const industry = document.getElementById('industryContext').value;
            const entities = document.getElementById('externalEntities').value.split('\n').filter(e => e.trim());
            const processes = document.getElementById('processes').value.split('\n').filter(p => p.trim());
            const stores = document.getElementById('dataStores').value.split('\n').filter(s => s.trim());
            
            pipelineData.dfd = {
                project_name: projectName || 'Sample Project',
                industry_context: industry,
                external_entities: entities,
                processes: processes,
                assets: stores,
                data_flows: generateSampleFlows(entities, processes, stores)
            };
            
            updateStepStatus(1, 'completed');
            updateStatistics();
            updatePanels(1);
        }

        function generateSampleFlows(entities, processes, stores) {
            // Generate some sample data flows
            const flows = [];
            if (entities.length > 0 && processes.length > 0) {
                flows.push({
                    source: entities[0].split('(')[0].trim(),
                    destination: processes[0].split('(')[0].trim(),
                    data_description: "User requests and authentication tokens",
                    data_classification: "Confidential",
                    protocol: "HTTPS",
                    authentication_mechanism: "JWT"
                });
            }
            return flows;
        }

        function generateThreats() {
            // Simulate threat generation
            if (!pipelineData.dfd) {
                alert('Please generate DFD first');
                return;
            }
            
            pipelineData.threats = [
                {
                    component_name: "U to WS",
                    stride_category: "S",
                    threat_description: "An attacker could spoof user identity to gain unauthorized access",
                    mitigation_suggestion: "Implement strong multi-factor authentication",
                    impact: "High",
                    likelihood: "Medium"
                },
                {
                    component_name: "WS to DB",
                    stride_category: "T",
                    threat_description: "SQL injection attacks could allow data manipulation",
                    mitigation_suggestion: "Use parameterized queries and input validation",
                    impact: "Critical",
                    likelihood: "High"
                },
                {
                    component_name: "DB",
                    stride_category: "I",
                    threat_description: "Sensitive data could be exposed if database is compromised",
                    mitigation_suggestion: "Implement encryption at rest and access controls",
                    impact: "Critical",
                    likelihood: "Low"
                }
            ];
            
            updateStepStatus(2, 'completed');
            updateStatistics();
            updatePanels(2);
        }

        function refineThreats() {
            // Simulate threat refinement
            if (!pipelineData.threats || pipelineData.threats.length === 0) {
                alert('Please generate threats first');
                return;
            }
            
            // Add refined fields to threats
            pipelineData.refinedThreats = pipelineData.threats.map(threat => ({
                ...threat,
                risk_score: calculateRiskScore(threat.impact, threat.likelihood),
                residual_risk_score: "Medium",
                exploitability: "Medium",
                mitigation_maturity: "Mature",
                justification: "Based on current architecture and controls",
                risk_statement: `${threat.threat_description} could lead to significant business impact`
            }));
            
            updateStepStatus(3, 'completed');
            updateStatistics();
            updatePanels(3);
        }

        function analyzeAttackPaths() {
            // Simulate attack path analysis
            if (!pipelineData.refinedThreats || pipelineData.refinedThreats.length === 0) {
                alert('Please refine threats first');
                return;
            }
            
            pipelineData.attackPaths = [
                {
                    path_id: "AP_001",
                    scenario_name: "External Attack to Database Breach",
                    entry_point: "User Interface",
                    target_asset: "Customer Database",
                    combined_impact: "Critical",
                    path_feasibility: "Realistic",
                    time_to_compromise: "Days",
                    path_steps: [
                        {
                            component: "Web App",
                            stride_category: "S",
                            threat_description: "Spoofing attack"
                        },
                        {
                            component: "API",
                            stride_category: "E",
                            threat_description: "Privilege escalation"
                        },
                        {
                            component: "Database",
                            stride_category: "I",
                            threat_description: "Data exfiltration"
                        }
                    ]
                }
            ];
            
            updateStepStatus(4, 'completed');
            updateStatistics();
            updatePanels(4);
        }

        function calculateRiskScore(impact, likelihood) {
            const impactMap = {Critical: 4, High: 3, Medium: 2, Low: 1};
            const likelihoodMap = {High: 3, Medium: 2, Low: 1};
            const score = impactMap[impact] * likelihoodMap[likelihood];
            if (score >= 9) return "Critical";
            if (score >= 6) return "High";
            if (score >= 3) return "Medium";
            return "Low";
        }

        function updateStepStatus(step, status) {
            const stepElement = document.getElementById(`step-${step}`);
            const indicator = stepElement.querySelector('.status-indicator');
            const text = stepElement.querySelector('.status-text');
            
            indicator.className = `status-indicator ${status}`;
            text.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            if (status === 'completed') {
                stepElement.classList.add('completed');
            }
        }

        function updateStatistics() {
            document.getElementById('stat-components').textContent = 
                (pipelineData.dfd ? pipelineData.dfd.processes.length + pipelineData.dfd.assets.length : 0);
            document.getElementById('stat-threats').textContent = pipelineData.threats.length;
            document.getElementById('stat-critical').textContent = 
                pipelineData.threats.filter(t => t.impact === 'Critical').length;
            document.getElementById('stat-paths').textContent = pipelineData.attackPaths.length;
        }

        function editThreat(index) {
            const threat = pipelineData.threats[index];
            document.getElementById('modalTitle').textContent = 'Edit Threat';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Component</label>
                    <input type="text" class="form-control" id="editComponent" value="${threat.component_name}">
                </div>
                <div class="form-group">
                    <label class="form-label">STRIDE Category</label>
                    <select class="form-control" id="editStride">
                        <option value="S" ${threat.stride_category === 'S' ? 'selected' : ''}>Spoofing</option>
                        <option value="T" ${threat.stride_category === 'T' ? 'selected' : ''}>Tampering</option>
                        <option value="R" ${threat.stride_category === 'R' ? 'selected' : ''}>Repudiation</option>
                        <option value="I" ${threat.stride_category === 'I' ? 'selected' : ''}>Information Disclosure</option>
                        <option value="D" ${threat.stride_category === 'D' ? 'selected' : ''}>Denial of Service</option>
                        <option value="E" ${threat.stride_category === 'E' ? 'selected' : ''}>Elevation of Privilege</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="editDescription">${threat.threat_description}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Impact</label>
                    <select class="form-control" id="editImpact">
                        <option value="Critical" ${threat.impact === 'Critical' ? 'selected' : ''}>Critical</option>
                        <option value="High" ${threat.impact === 'High' ? 'selected' : ''}>High</option>
                        <option value="Medium" ${threat.impact === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="Low" ${threat.impact === 'Low' ? 'selected' : ''}>Low</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="saveThreatEdit(${index})">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;
            document.getElementById('editModal').classList.add('show');
        }

        function saveThreatEdit(index) {
            pipelineData.threats[index] = {
                ...pipelineData.threats[index],
                component_name: document.getElementById('editComponent').value,
                stride_category: document.getElementById('editStride').value,
                threat_description: document.getElementById('editDescription').value,
                impact: document.getElementById('editImpact').value
            };
            closeModal();
            updatePanels(2);
            updateStatistics();
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        function loadSampleData() {
            // Load sample data for testing
            pipelineData = {
                dfd: {
                    project_name: "E-Commerce Platform",
                    industry_context: "Retail",
                    external_entities: ["User (U)", "Payment Gateway", "Admin"],
                    processes: ["Web Server (WS)", "API Gateway (API)", "Payment Processor (PP)"],
                    assets: ["Customer DB", "Product DB", "Session Store"],
                    data_flows: []
                },
                threats: [],
                refinedThreats: [],
                attackPaths: []
            };
            updateStepStatus(1, 'completed');
            updateStatistics();
            updatePanels(1);
        }

        function exportResults() {
            const data = JSON.stringify(pipelineData, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'threat_model_export.json';
            a.click();
        }

        function validateResults() {
            alert('Validation completed! All data appears valid.');
        }

        // Tab switching functions
        function showDFDTab(tab) {
            document.querySelectorAll('#dfd-tab-content').forEach(t => t.classList.remove('active'));
            // Implementation for different tabs
        }

        function renderDFDOverview() {
            return `
                <div class="data-grid">
                    <div class="data-item">
                        <h4>Project: ${pipelineData.dfd.project_name}</h4>
                        <p>Industry: ${pipelineData.dfd.industry_context}</p>
                    </div>
                    <div class="data-item">
                        <h4>Components</h4>
                        <p>External Entities: ${pipelineData.dfd.external_entities.length}</p>
                        <p>Processes: ${pipelineData.dfd.processes.length}</p>
                        <p>Data Stores: ${pipelineData.dfd.assets.length}</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>